name: Deploy to TimeWeb

on:
  push:
    branches:
      - main  # Измените на вашу ветку если нужно
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - '*.bak.*'
      - '*.broken.*'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p /home/runner/.ssh
        printf '%s' "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > /home/runner/.ssh/id_rsa
        chmod 600 /home/runner/.ssh/id_rsa
        test -s /home/runner/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> /home/runner/.ssh/known_hosts
        ls -l /home/runner/.ssh
    
    - name: Deploy to server
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PATH: ${{ secrets.SERVER_PATH }}
        SSH_OPTS: "-o IdentitiesOnly=yes -i /home/runner/.ssh/id_rsa"
      run: |
        # Создаем временный exclude файл
        cat > /tmp/rsync_exclude << EOF
        .bak.*
        *.bak.*
        .git/
        .gitignore
        .env
        *.db
        *.sqlite
        *.sqlite3
        *.log
        *.pid
        __pycache__/
        *.pyc
        *.pyo
        .venv/
        venv/
        .DS_Store
        deploy.conf
        .github/
        EOF
        
        # Синхронизируем файлы
        rsync -avz --delete \
          --exclude-from=/tmp/rsync_exclude \
          -e "ssh ${{ secrets.SSH_OPTS }}" \
          ./ "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/"
    
    - name: Install dependencies and restart
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PATH: ${{ secrets.SERVER_PATH }}
        SSH_OPTS: "-o IdentitiesOnly=yes -i /home/runner/.ssh/id_rsa"
      run: |
        ssh ${{ secrets.SSH_OPTS }} "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << 'ENDSSH'
          cd ${{ secrets.SERVER_PATH }}
          pip install --quiet --no-cache-dir -r requirements.txt
          chmod +x restart.sh 2>/dev/null || true
          ./restart.sh || echo "⚠️ Команда restart.sh не выполнена, перезапустите вручную"
        ENDSSH
    
    - name: Deployment status
      run: |
        echo "✅ Деплой завершен успешно!"
