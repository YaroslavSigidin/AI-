name: Deploy to TimeWeb

on:
  push:
    branches:
      - main  # Измените на вашу ветку если нужно
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p /home/runner/.ssh
        printf '%s' "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | tr -d '\r' | base64 -d > /home/runner/.ssh/id_rsa
        chmod 600 /home/runner/.ssh/id_rsa
        test -s /home/runner/.ssh/id_rsa
        ssh-keygen -lf /home/runner/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> /home/runner/.ssh/known_hosts
        ls -l /home/runner/.ssh
    
    - name: Deploy to server
      env:
        SERVER_HOST: "85.193.89.214"
        SERVER_USER: "root"
        SERVER_PATH: "/root/ai_trainer_cursor"
      run: |
        SSH_CMD="ssh -o IdentitiesOnly=yes -i /home/runner/.ssh/id_rsa"
        # Создаем временный exclude файл
        cat > /tmp/rsync_exclude << EOF
        .bak.*
        *.bak.*
        .git/
        .gitignore
        .env
        *.db
        *.sqlite
        *.sqlite3
        *.log
        *.pid
        __pycache__/
        *.pyc
        *.pyo
        .venv/
        venv/
        .DS_Store
        deploy.conf
        .github/
        EOF
        
        # Синхронизируем файлы
        rsync -avz --delete \
          --exclude-from=/tmp/rsync_exclude \
          -e "$SSH_CMD" \
          ./ "${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/"
    
    - name: Install dependencies and restart
      env:
        SERVER_HOST: "85.193.89.214"
        SERVER_USER: "root"
        SERVER_PATH: "/root/ai_trainer_cursor"
      run: |
        ssh -o IdentitiesOnly=yes -i /home/runner/.ssh/id_rsa "${SERVER_USER}@${SERVER_HOST}" << 'ENDSSH'
          cd /root/ai_trainer_cursor
          pip install --quiet --no-cache-dir -r requirements.txt
          chmod +x restart.sh 2>/dev/null || true
          ./restart.sh || echo "⚠️ Команда restart.sh не выполнена, перезапустите вручную"
        ENDSSH
    
    - name: Deployment status
      run: |
        echo "✅ Деплой завершен успешно!"
